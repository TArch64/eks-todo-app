version: 0.2

env:
  variables:
    CR_HOST: "ghcr.io"

phases:
  pre_build:
    commands:
      - >-
        eval $( \
          aws ssm get-parameters-by-path --path '/eks-todo-app' --no-paginate --with-decryption \
          | jq -r '.Parameters[] | "export " + (.Name | split("/")[-1] | ascii_upcase | gsub("-"; "_")) + "=" + .Value' \
        )

      - echo "$CR_PASSWORD" | docker login "$CR_HOST" --username "$CR_USER" --password-stdin

      - export DOCKER_BUILDKIT=1
      - export BUILDKIT_INLINE_CACHE=1

      - export CR_BASE="$CR_HOST/$CR_USER"

      - docker pull $CR_BASE/eks-todo-app-backend:latest || true
      - docker pull $CR_BASE/eks-todo-app-nginx:latest || true

  build:
    commands:
      - >-
        docker buildx \
          --platform linux/amd64,linux/arm64,darwin/amd64,darwin/arm64 \
          --tag eks-app-backend \
          --file ci/dockerfiles/backend.Dockerfile \
          --cache-from $CR_BASE/eks-todo-app-backend \
          --build-arg BUILDKIT_INLINE_CACHE \
          .

      - >-
        docker buildx \
          --platform linux/amd64,linux/arm64,darwin/amd64,darwin/arm64 \
          --tag eks-app-nginx \
          --file ci/dockerfiles/nginx.Dockerfile \
          --cache-from $CR_BASE/eks-todo-app-nginx \
          --build-arg BUILDKIT_INLINE_CACHE \
          .

  post_build:
    commands:
      - docker tag eks-app-backend $CR_BASE/eks-todo-app-backend:latest
      - docker tag eks-app-backend $CR_BASE/eks-todo-app-backend:$CODEBUILD_BUILD_NUMBER
      - docker push $CR_BASE/eks-todo-app-backend -a

      - docker tag eks-app-nginx $CR_BASE/eks-todo-app-nginx:latest
      - docker tag eks-app-nginx $CR_BASE/eks-todo-app-nginx:$CODEBUILD_BUILD_NUMBER
      - docker push $CR_BASE/eks-todo-app-nginx -a
